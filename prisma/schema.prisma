// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model Team {
  id          String        @id @default(cuid())
  name        String
  managerId   String
  manager     User          @relation("ManagerOfTeam", fields: [managerId], references: [id], onDelete: Cascade)
  members     User[]        @relation("TeamMembers")
  workstations Workstation[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([managerId])
}

model Workstation {
  id        String   @id @default(cuid())
  name      String
  teamId    String?
  team      Team?    @relation(fields: [teamId], references: [id], onDelete: Cascade)

  employees      EmployeeWorkstation[]
  taskTemplates  TaskTemplate[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([teamId, name])
  @@index([teamId])
}

model EmployeeWorkstation {
  id            String   @id @default(cuid())
  employeeId    String
  employee      User     @relation("EmployeeWorkstations", fields: [employeeId], references: [id], onDelete: Cascade)
  workstationId String
  workstation   Workstation @relation(fields: [workstationId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([employeeId, workstationId])
  @@index([employeeId])
  @@index([workstationId])
}

model User {
  id              String   @id @default(cuid())
  name            String
  email           String   @unique
  passwordHash    String
  role            String   @default("EMPLOYEE") // App: 'MANAGER'|'EMPLOYEE' + isRole() at token gen. Optional (SQLite): CHECK(role IN ('MANAGER','EMPLOYEE')) via raw migration.

  teamId          String?
  team            Team?    @relation("TeamMembers", fields: [teamId], references: [id], onDelete: SetNull)

  workstations    EmployeeWorkstation[] @relation("EmployeeWorkstations")

  managedTeams    Team[]   @relation("ManagerOfTeam")
  dailyTasks        DailyTask[]
  createdTasks      TaskTemplate[] @relation("TaskCreator")
  setPasswordToken  SetPasswordToken?
  passwordResetToken PasswordResetToken?
  assignedTasks   TaskTemplate[] @relation("AssignedTasks")
  dayPreparations DayPreparation[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([teamId])
}

model TaskTemplate {
  id              String   @id @default(cuid())
  title           String
  description     String?

  workstationId   String?
  workstation     Workstation? @relation(fields: [workstationId], references: [id], onDelete: Cascade)

  assignedToEmployeeId String?
  assignedToEmployee   User? @relation("AssignedTasks", fields: [assignedToEmployeeId], references: [id], onDelete: Cascade)

  createdById     String
  createdBy       User     @relation("TaskCreator", fields: [createdById], references: [id], onDelete: Cascade)

  isRecurring     Boolean  @default(true)
  recurrenceType  String   @default("daily") // daily | weekly | x_per_week
  recurrenceDays  String? // CSV of 0..6 (0=Sunday), e.g. "1,3,5"
  targetPerWeek   Int?
  notifyEmployee  Boolean  @default(true)
  dailyTasks      DailyTask[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([workstationId])
  @@index([assignedToEmployeeId])
  @@index([createdById])
}

model SetPasswordToken {
  id        String   @id @default(cuid())
  userId    String   @unique
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  tokenHash String   @unique
  expiresAt DateTime

  @@index([tokenHash])
  @@index([expiresAt])
}

model PasswordResetToken {
  id        String   @id @default(cuid())
  userId    String   @unique
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  tokenHash String   @unique
  expiresAt DateTime

  @@index([tokenHash])
  @@index([expiresAt])
}

model DailyTask {
  id              String   @id @default(cuid())
  
  taskTemplateId  String
  taskTemplate    TaskTemplate @relation(fields: [taskTemplateId], references: [id], onDelete: Cascade)
  
  employeeId      String?
  employee        User?    @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  
  date            DateTime
  status          String   @default("ASSIGNED") // UNASSIGNED | ASSIGNED | DONE
  isCompleted     Boolean  @default(false)
  completedAt     DateTime?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@unique([taskTemplateId, employeeId, date])
  @@index([employeeId])
  @@index([taskTemplateId])
  @@index([date])
  @@index([status])
}

model DayPreparation {
  id         String   @id @default(cuid())
  managerId  String
  manager    User     @relation(fields: [managerId], references: [id], onDelete: Cascade)
  date       DateTime
  preparedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([managerId, date])
  @@index([date])
}
